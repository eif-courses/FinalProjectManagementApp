<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .T "reports.supervisor_report" }} - {{ .Student.GetFullName }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50 font-sans">
<!-- Navigation -->
<nav class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <a href="/supervisor/students" class="text-gray-500 hover:text-gray-700 mr-4">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-xl font-semibold text-gray-800">{{ .T "reports.supervisor_report" }}</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">{{ .User.Name }}</span>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <div class="text-center mb-6">
            <img src="/static/images/viko-logo.png" alt="VIKO" class="h-16 mx-auto mb-4">
            <h2 class="text-xl font-bold uppercase">{{ .T "institution.name" }}</h2>
            <h3 class="text-lg font-semibold">{{ .T "institution.faculty" }}</h3>
            <h4 class="text-md">{{ .Department }}</h4>
            <div class="mt-4">
                <h1 class="text-2xl font-bold">{{ .T "reports.supervisor_report_title" }}</h1>
            </div>
        </div>

        <!-- Student Information -->
        <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
            <div>
                <span class="font-semibold">{{ .T "student_fields.study_program" }}:</span>
                <span>{{ .Student.StudyProgram }}, {{ .T "student_fields.course_code" }} {{ .Student.ProgramCode }}</span>
            </div>
            <div>
                <span class="font-semibold">{{ .T "student_fields.student_name" }}:</span>
                <span>{{ .Student.GetFullName }}</span>
            </div>
            <div class="col-span-2">
                <span class="font-semibold">{{ .T "topic_fields.title" }}:</span>
                <span>{{ .Student.FinalProjectTitle }}</span>
            </div>
        </div>
    </div>

    <!-- Report Form -->
    <form id="supervisorReportForm"
          hx-post="/supervisor/reports/{{ .Student.ID }}"
          hx-target="#formResult"
          class="bg-white shadow rounded-lg p-6">

        <!-- Supervisor Details -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-4">{{ .T "report_fields.supervisor_details" }}</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ .T "report_fields.supervisor_name" }} <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           name="supervisor_name"
                           value="{{ .Report.SupervisorName }}"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ .T "report_fields.supervisor_position" }} <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           name="supervisor_position"
                           value="{{ .Report.SupervisorPosition }}"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ .T "report_fields.supervisor_workplace" }} <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           name="supervisor_workplace"
                           value="{{ .Report.SupervisorWorkplace }}"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- Plagiarism Check Results -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-4">{{ .T "report_fields.plagiarism_check" }}</h3>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    {{ .T "report_fields.plagiarism_check_info" }}
                </p>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ .T "report_fields.other_match" }} (%)
                    </label>
                    <input type="number"
                           name="other_match"
                           value="{{ .Report.OtherMatch }}"
                           min="0"
                           max="100"
                           step="0.1"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ .T "report_fields.one_match" }} (%)
                    </label>
                    <input type="number"
                           name="one_match"
                           value="{{ .Report.OneMatch }}"
                           min="0"
                           max="100"
                           step="0.1"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ .T "report_fields.own_match" }} (%)
                    </label>
                    <input type="number"
                           name="own_match"
                           value="{{ .Report.OwnMatch }}"
                           min="0"
                           max="100"
                           step="0.1"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ .T "report_fields.join_match" }} (%)
                    </label>
                    <input type="number"
                           name="join_match"
                           value="{{ .Report.JoinMatch }}"
                           min="0"
                           max="100"
                           step="0.1"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="mt-2 text-sm text-gray-600">
                {{ .T "report_fields.total_similarity" }}: <span id="totalSimilarity" class="font-semibold">0</span>%
            </div>
        </div>

        <!-- Supervisor Comments -->
        <div class="mb-8">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                {{ .T "report_fields.supervisor_comments" }} <span class="text-red-500">*</span>
            </label>
            <textarea name="supervisor_comments"
                      rows="6"
                      required
                      placeholder="{{ .T 'report_fields.supervisor_comments_placeholder' }}"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ .Report.SupervisorComments }}</textarea>
        </div>

        <!-- Grade and Pass/Fail -->
        <div class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ .T "report_fields.grade" }} <span class="text-red-500">*</span>
                    </label>
                    <select name="grade"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">{{ .T "grades.select_grade" }}</option>
                        {{ range $grade := .Grades }}
                        <option value="{{ $grade.Value }}" {{ if eq $.Report.Grade $grade.Value }}selected{{ end }}>
                            {{ $grade.Label }}
                        </option>
                        {{ end }}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ .T "report_fields.recommendation" }} <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-3 space-y-2">
                        <label class="inline-flex items-center">
                            <input type="radio"
                                   name="is_pass_or_failed"
                                   value="1"
                                   {{ if .Report.IsPassOrFailed }}checked{{ end }}
                                   required
                                   class="form-radio h-4 w-4 text-green-600">
                            <span class="ml-2 text-sm">{{ .T "report_fields.recommend_defense" }}</span>
                        </label>
                        <br>
                        <label class="inline-flex items-center">
                            <input type="radio"
                                   name="is_pass_or_failed"
                                   value="0"
                                   {{ if not .Report.IsPassOrFailed }}checked{{ end }}
                                   required
                                   class="form-radio h-4 w-4 text-red-600">
                            <span class="ml-2 text-sm">{{ .T "report_fields.not_recommend_defense" }}</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Comments -->
        <div class="mb-8">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                {{ .T "report_fields.final_comments" }}
            </label>
            <textarea name="final_comments"
                      rows="4"
                      placeholder="{{ .T 'report_fields.final_comments_placeholder' }}"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ .Report.FinalComments }}</textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between items-center pt-6 border-t">
            <div class="flex items-center">
                <input type="checkbox"
                       name="is_signed"
                       id="is_signed"
                       {{ if .Report.IsSigned }}checked disabled{{ end }}
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="is_signed" class="ml-2 text-sm text-gray-700">
                    {{ .T "report_fields.sign_report" }}
                </label>
            </div>

            <div class="flex space-x-3">
                <button type="button"
                        onclick="window.location.href='/supervisor/students'"
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    {{ .T "common.cancel" }}
                </button>

                {{ if not .Report.IsSigned }}
                <button type="submit"
                        name="action"
                        value="save"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-save mr-1"></i>{{ .T "common.save" }}
                </button>

                <button type="submit"
                        name="action"
                        value="sign"
                        onclick="return confirm('{{ .T "report_fields.sign_confirmation" }}')"
                class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-signature mr-1"></i>{{ .T "report_fields.sign_and_submit" }}
                </button>
                {{ else }}
                <button type="button"
                        onclick="window.print()"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                    <i class="fas fa-print mr-1"></i>{{ .T "common.print" }}
                </button>
                {{ end }}
            </div>
        </div>
    </form>

    <div id="formResult" class="mt-4"></div>
</div>

<script>
    // Calculate total similarity
    function calculateTotalSimilarity() {
        const otherMatch = parseFloat(document.querySelector('input[name="other_match"]').value) || 0;
        const oneMatch = parseFloat(document.querySelector('input[name="one_match"]').value) || 0;
        const ownMatch = parseFloat(document.querySelector('input[name="own_match"]').value) || 0;
        const joinMatch = parseFloat(document.querySelector('input[name="join_match"]').value) || 0;

        const total = otherMatch + oneMatch + ownMatch + joinMatch;
        document.getElementById('totalSimilarity').textContent = total.toFixed(1);

        // Color coding based on total
        const element = document.getElementById('totalSimilarity');
        if (total <= 15) {
            element.className = 'font-semibold text-green-600';
        } else if (total <= 25) {
            element.className = 'font-semibold text-yellow-600';
        } else {
            element.className = 'font-semibold text-red-600';
        }
    }

    // Add event listeners to similarity inputs
    document.querySelectorAll('input[name$="_match"]').forEach(input => {
        input.addEventListener('input', calculateTotalSimilarity);
    });

    // Calculate on page load
    calculateTotalSimilarity();

    // Print styles
    const printStyles = `
            @media print {
                nav, .no-print, button, input[type="checkbox"] { display: none !important; }
                body { background: white; }
                .shadow { box-shadow: none !important; }
                .bg-gray-50 { background: white !important; }
            }
        `;
    const styleSheet = document.createElement("style");
    styleSheet.innerText = printStyles;
    document.head.appendChild(styleSheet);
</script>
</body>
</html>