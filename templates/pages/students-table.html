{{template "base.html" .}}

{{define "content"}}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-800">{{call .T "student_management"}}</h1>
        <p class="text-gray-600">{{call .T "manage_thesis_topics"}}</p>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex flex-wrap gap-4 items-center">
            <!-- Search -->
            <div class="relative flex-1 min-w-64">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" placeholder="{{call .T "search_placeholder"}}"
                hx-get="/api/students/search"
                hx-trigger="keyup changed delay:300ms"
                hx-target="#students-table-body"
                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Items per page -->
            <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>

            <!-- Filters -->
            <div class="flex gap-3">
                <!-- Years Filter -->
                <div class="relative">
                    <button onclick="toggleDropdown('years')"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                        {{call .T "years"}} <span class="text-gray-500">{{call .T "current"}}</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="years-dropdown" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-48">
                        <div class="p-3">
                            {{range .Data.Years}}
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" value="{{.}}"> {{.}}
                            </label>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Groups Filter -->
                <div class="relative">
                    <button onclick="toggleDropdown('groups')"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                        {{call .T "group"}} <span class="text-gray-500">{{call .T "all"}}</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="groups-dropdown" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-48">
                        <div class="p-3">
                            {{range .Data.Groups}}
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" value="{{.}}"> {{.}}
                            </label>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Study Programs Filter -->
                <div class="relative">
                    <button onclick="toggleDropdown('programs')"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                        {{call .T "study_program"}} <span class="text-gray-500">{{call .T "all"}}</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="programs-dropdown" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-64">
                        <div class="p-3">
                            {{range .Data.Programs}}
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" value="{{.}}"> {{.}}
                            </label>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Reset Filter -->
                <button onclick="resetFilters()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                    <i class="fas fa-filter"></i>
                    {{call .T "reset_filter"}}
                </button>
            </div>
        </div>
    </div>

    <!-- Desktop Table -->
    <div class="hidden md:block bg-white rounded-lg shadow-sm overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
                <th class="text-left p-4 font-medium text-gray-700">
                    <div class="flex items-center gap-2 cursor-pointer hover:bg-gray-100 rounded px-2 py-1" onclick="sortTable('group')">
                        {{call .T "group"}} <i class="fas fa-sort text-gray-400"></i>
                    </div>
                </th>
                <th class="text-left p-4 font-medium text-gray-700">
                    <div class="flex items-center gap-2 cursor-pointer hover:bg-gray-100 rounded px-2 py-1" onclick="sortTable('name')">
                        {{call .T "name_surname"}} <i class="fas fa-sort text-gray-400"></i>
                    </div>
                </th>
                <th class="text-left p-4 font-medium text-gray-700">
                    <div class="flex items-center gap-2 cursor-pointer hover:bg-gray-100 rounded px-2 py-1" onclick="sortTable('topic')">
                        {{call .T "topic_registration"}} <i class="fas fa-sort text-gray-400"></i>
                    </div>
                </th>
                <th class="text-left p-4 font-medium text-gray-700">{{call .T "documents"}}</th>
                <th class="text-left p-4 font-medium text-gray-700">
                    <div class="flex items-center gap-2 cursor-pointer hover:bg-gray-100 rounded px-2 py-1" onclick="sortTable('review')">
                        {{call .T "supervisor_review"}} <i class="fas fa-sort text-gray-400"></i>
                    </div>
                </th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="students-table-body">
            {{range .Data.Students}}
            <tr class="hover:bg-gray-50">
                <td class="p-4">
                    <div class="font-medium text-gray-900">{{.Group}}</div>
                </td>
                <td class="p-4">
                    <div class="font-medium text-gray-900">{{.StudentName}}</div>
                    <div class="text-sm text-gray-500">{{.ProjectTitle}}</div>
                </td>
                <td class="p-4">
                    {{if .TopicApproved}}
                    <div class="text-green-600 font-medium">{{call $.T "approved_by_head"}}</div>
                    <button onclick="openModal('view-topic-modal', {{.ID}})"
                            class="mt-2 bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded flex items-center gap-1 text-sm">
                        <i class="fas fa-eye"></i> {{call $.T "view"}}
                    </button>
                    {{else}}
                    <span class="text-gray-500">{{call $.T "not_started"}}</span>
                    {{end}}
                </td>
                <td class="p-4">
                    {{if .HasVideo}}
                    <button onclick="openVideoModal({{.ID}})" class="text-purple-600 hover:text-purple-800">
                        <i class="fas fa-video text-lg"></i>
                    </button>
                    {{end}}
                </td>
                <td class="p-4">
                    {{if .SupervisorReportExists}}
                    <button onclick="openModal('view-report-modal', {{.ID}})"
                            class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-eye"></i> {{call $.T "view"}}
                    </button>
                    {{else}}
                    <button onclick="openModal('fill-report-modal', {{.ID}})"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-edit"></i> {{call $.T "fill"}}
                    </button>
                    {{end}}
                </td>
            </tr>
            {{end}}
            </tbody>
        </table>
    </div>

    <!-- Mobile Cards (visible on mobile) -->
    <div class="md:hidden space-y-4">
        {{range .Data.Students}}
        <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <div class="font-medium text-gray-900">{{.StudentName}}</div>
                    <div class="text-sm text-gray-500">{{.Group}}</div>
                </div>
                <div class="text-right">
                    {{if .TopicApproved}}
                    <span class="text-green-600 text-sm font-medium">{{call $.T "approved_by_head"}}</span>
                    {{else}}
                    <span class="text-gray-500 text-sm">{{call $.T "not_started"}}</span>
                    {{end}}
                </div>
            </div>

            <div class="text-sm text-gray-600 mb-3">
                <div class="font-medium">{{call $.T "project_title"}}:</div>
                <div>{{.ProjectTitle}}</div>
            </div>

            <div class="flex gap-2 flex-wrap">
                {{if .SupervisorReportExists}}
                <button onclick="openModal('view-report-modal', {{.ID}})"
                        class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded">
                    <i class="fas fa-eye"></i> {{call $.T "view"}}
                </button>
                {{else}}
                <button onclick="openModal('fill-report-modal', {{.ID}})"
                        class="text-xs bg-blue-500 text-white px-3 py-1 rounded">
                    <i class="fas fa-edit"></i> {{call $.T "fill"}}
                </button>
                {{end}}

                {{if .HasVideo}}
                <button onclick="openVideoModal({{.ID}})"
                        class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded">
                    <i class="fas fa-video"></i>
                </button>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>

    <!-- Pagination -->
    <div class="mt-6 flex justify-between items-center">
        <div class="text-sm text-gray-500">
            {{call .T "showing_results" 1 10 10}}
        </div>
        <div class="flex gap-2">
            <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50" disabled>
                {{call .T "previous"}}
            </button>
            <button class="px-3 py-1 bg-blue-500 text-white rounded">1</button>
            <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">2</button>
            <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">3</button>
            <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">
                {{call .T "next"}}
            </button>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Fill Report Modal -->
<div id="fill-report-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">{{call .T "supervisor_report"}}</h2>
                <button onclick="closeModal('fill-report-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <form class="space-y-4" onsubmit="submitReport(event)">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "student"}}</label>
                    <input type="text" id="student-name" disabled
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "topic"}}</label>
                    <input type="text" id="project-title" disabled
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "supervisor_comments"}}</label>
                    <textarea rows="4" placeholder="{{call .T "enter_comments"}}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "grade"}}</label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="">{{call .T "select_grade"}}</option>
                        <option value="10">{{call .T "excellent"}}</option>
                        <option value="9">{{call .T "very_good"}}</option>
                        <option value="8">{{call .T "good"}}</option>
                        <option value="7">{{call .T "satisfactory"}}</option>
                        <option value="6">{{call .T "weak"}}</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('fill-report-modal')"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        {{call .T "cancel"}}
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        {{call .T "save"}}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Report Modal -->
<div id="view-report-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">{{call .T "supervisor_report"}}</h2>
                <button onclick="closeModal('view-report-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "student"}}</label>
                    <p class="text-gray-900" id="view-student-name">TestVardas StudentasPavarde</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "topic"}}</label>
                    <p class="text-gray-900" id="view-project-title">Baigiamųjų darbų talykla</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "supervisor_comments"}}</label>
                    <p class="text-gray-900 bg-gray-50 p-3 rounded" id="view-comments">Puikus projektas. Studentas demonstravo aukštą technologijų supratimo lygį ir gebėjimą spręsti sudėtingas problemas.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "grade"}}</label>
                    <p class="text-green-600 font-medium" id="view-grade">{{call .T "excellent"}}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "submission_date"}}</label>
                    <p class="text-gray-900" id="view-date">2024-01-15</p>
                </div>
            </div>
            <div class="flex justify-end pt-6">
                <button onclick="closeModal('view-report-modal')"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    {{call .T "close"}}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Topic Modal -->
<div id="view-topic-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">{{call .T "topic_registration"}}</h2>
                <button onclick="closeModal('view-topic-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "project_title"}}</label>
                    <p class="text-gray-900">Baigiamųjų darbų talykla</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "project_title_en"}}</label>
                    <p class="text-gray-900">Thesis Management System</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "problem_statement"}}</label>
                    <p class="text-gray-900 bg-gray-50 p-3 rounded">Šiuo metu trūksta centralizuotos sistemos baigiamųjų darbų valdymui universitete...</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "objective"}}</label>
                    <p class="text-gray-900 bg-gray-50 p-3 rounded">Sukurti web aplikaciją baigiamųjų darbų valdymui...</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{call .T "tasks"}}</label>
                    <p class="text-gray-900 bg-gray-50 p-3 rounded">1. Sistemos analizė<br>2. Duomenų bazės projektavimas<br>3. Sistemos realizacija...</p>
                </div>
            </div>
            <div class="flex justify-end pt-6">
                <button onclick="closeModal('view-topic-modal')"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    {{call .T "close"}}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentSort = { column: '', direction: 'asc' };

    function toggleDropdown(id) {
        const dropdown = document.getElementById(id + '-dropdown');
        const allDropdowns = document.querySelectorAll('[id$="-dropdown"]');

        allDropdowns.forEach(dd => {
            if (dd.id !== id + '-dropdown') {
                dd.classList.add('hidden');
            }
        });

        dropdown.classList.toggle('hidden');
    }

    function openModal(modalId, studentId = null) {
        if (studentId) {
            // In a real app, you would fetch student data via API
            // For demo, just populate with dummy data
            if (modalId === 'fill-report-modal') {
                document.getElementById('student-name').value = 'Studentas Studentauskas';
                document.getElementById('project-title').value = 'Gyvinų internetinė parduotuvė';
            }
        }

        document.getElementById(modalId).classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function openVideoModal(studentId) {
        // In a real app, this would open a video player modal
        alert('{{call .T "video_player"}} - Student ID: ' + studentId);
    }

    function sortTable(column) {
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }

        // In a real app, this would trigger an API call to sort data
        console.log('Sorting by:', column, currentSort.direction);
    }

    function resetFilters() {
        // Reset all checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

        // Reset search
        document.querySelector('input[type="text"]').value = '';

        // In a real app, trigger table refresh
        console.log('Filters reset');
    }

    function submitReport(event) {
        event.preventDefault();

        // In a real app, this would submit to API
        alert('{{call .T "success_saved"}}');
        closeModal('fill-report-modal');

        // Optionally refresh the table
        location.reload();
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.relative')) {
            document.querySelectorAll('[id$="-dropdown"]').forEach(dd => {
                dd.classList.add('hidden');
            });
        }
    });

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('fixed')) {
            closeModal('fill-report-modal');
            closeModal('view-report-modal');
            closeModal('view-topic-modal');
        }
    });
</script>
{{end}}